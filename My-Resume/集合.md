## é›†åˆæ¦‚è¿°

### Java é›†åˆæ¦‚è§ˆ

Java é›†åˆï¼Œ ä¹Ÿå«ä½œå®¹å™¨ï¼Œä¸»è¦æ˜¯ç”±ä¸¤å¤§æ¥å£æ´¾ç”Ÿè€Œæ¥ï¼šä¸€ä¸ªæ˜¯ `Collection`æ¥å£ï¼Œä¸»è¦ç”¨äºå­˜æ”¾å•ä¸€å…ƒç´ ï¼›å¦ä¸€ä¸ªæ˜¯ `Map` æ¥å£ï¼Œä¸»è¦ç”¨äºå­˜æ”¾é”®å€¼å¯¹ã€‚å¯¹äº`Collection` æ¥å£ï¼Œä¸‹é¢åˆæœ‰ä¸‰ä¸ªä¸»è¦çš„å­æ¥å£ï¼š`List`ã€`Set` å’Œ `Queue`ã€‚



### è¯´è¯´ List, Set, Queue, Map å››è€…çš„åŒºåˆ«ï¼Ÿ
| \    | List | Set  | Queue | Map              |
|------|------|------|-------|------------------|
| æ’åº   | æœ‰åº   | æ— åº   | æœ‰åº    | æ— åº               |
| å¯å¦é‡å¤ | å¯é‡å¤  | ä¸å¯é‡å¤ | å¯é‡å¤   | keyä¸å¯é‡å¤ï¼Œvalueå¯é‡å¤ |

### å¸¸ç”¨é›†åˆç±»çš„ç‰¹ç‚¹

| \    | æ’åº | å¯å¦é‡å¤ | ç‰¹ç‚¹   | æ˜¯å¦å¯ä»¥æ’å…¥null |
|------|----|------|------|------------|
| ArrayList   | æœ‰åº | å¯é‡å¤  | æ•°ç»„   | å¯ä»¥         |
| LinkedList | æœ‰åº | å¯é‡å¤ | åŒå‘é“¾è¡¨ | å¯ä»¥         |
| HashSet   | æ— åº | ä¸å¯é‡å¤ | åŸºäº HashMap | ä¸å¯ä»¥         |
| TreeSet   | æœ‰åº | ä¸å¯é‡å¤ | åŸºäº TreeMap | ä¸å¯ä»¥         |
| PriorityQueue | æœ‰åº | å¯é‡å¤ | äºŒå‰å † | ä¸å¯ä»¥         |
| ArrayQueue   | æœ‰åº | å¯é‡å¤ | æ•°ç»„ + åŒæŒ‡é’ˆ | ä¸å¯ä»¥         |
| HashMap   | æ— åº | keyä¸å¯é‡å¤ï¼Œvalueå¯é‡å¤ | åŸºäºæ•°ç»„ + é“¾è¡¨ + çº¢é»‘æ ‘ | keyå¯ä»¥ï¼Œvalueå¯ä»¥ |
| LinkedHashMap   | æœ‰åº | keyä¸å¯é‡å¤ï¼Œvalueå¯é‡å¤ | åŸºäºæ•°ç»„ + é“¾è¡¨ + çº¢é»‘æ ‘ | keyå¯ä»¥ï¼Œvalueå¯ä»¥ |
| TreeMap   | æœ‰åº | keyä¸å¯é‡å¤ï¼Œvalueå¯é‡å¤ | åŸºäºçº¢é»‘æ ‘ | keyä¸å¯ä»¥ï¼Œvalueå¯ä»¥ |

### å¸¸ç”¨å®‰å…¨é›†åˆç±»çš„ç‰¹ç‚¹
| \    | æ’åº | å¯å¦é‡å¤ | ç‰¹ç‚¹   | æ˜¯å¦å¯ä»¥æ’å…¥null |
|------|----|------|------|------------|
| Vector   | æœ‰åº | å¯é‡å¤  | æ•°ç»„   | å¯ä»¥         |
| Stack | æœ‰åº | å¯é‡å¤ | æ•°ç»„ | å¯ä»¥         |
| Hashtable   | æ— åº | ä¸å¯é‡å¤ | åŸºäºæ•°ç»„ + é“¾è¡¨ | ä¸å¯ä»¥         |
| ConcurrentHashMap   | æ— åº | ä¸å¯é‡å¤ | åŸºäºæ•°ç»„ + é“¾è¡¨ + çº¢é»‘æ ‘ | ä¸å¯ä»¥         |
| CopyOnWriteArrayList   | æœ‰åº | å¯é‡å¤ | æ•°ç»„ + å¯é‡å…¥é” | å¯ä»¥         |
| CopyOnWriteArraySet   | æœ‰åº | ä¸å¯é‡å¤ | æ•°ç»„ + å¯é‡å…¥é” | å¯ä»¥         |
| ConcurrentSkipListMap   | æœ‰åº | keyä¸å¯é‡å¤ï¼Œvalueå¯é‡å¤ | åŸºäºè·³è¡¨ | keyä¸å¯ä»¥ï¼Œvalueå¯ä»¥ |
| ConcurrentSkipListSet   | æœ‰åº | ä¸å¯é‡å¤ | åŸºäºè·³è¡¨ | ä¸å¯ä»¥ |



### ArrayList æ’å…¥å’Œåˆ é™¤å…ƒç´ çš„æ—¶é—´å¤æ‚åº¦ï¼Ÿ

å¯¹äºæ’å…¥ï¼š

- å¤´éƒ¨æ’å…¥ï¼šç”±äºéœ€è¦å°†æ‰€æœ‰å…ƒç´ éƒ½ä¾æ¬¡å‘åç§»åŠ¨ä¸€ä¸ªä½ç½®ï¼Œå› æ­¤æ—¶é—´å¤æ‚åº¦æ˜¯ O(n)ã€‚
- å°¾éƒ¨æ’å…¥ï¼šå½“ `ArrayList` çš„å®¹é‡æœªè¾¾åˆ°æé™æ—¶ï¼Œå¾€åˆ—è¡¨æœ«å°¾æ’å…¥å…ƒç´ çš„æ—¶é—´å¤æ‚åº¦æ˜¯ O(1)ï¼Œå› ä¸ºå®ƒåªéœ€è¦åœ¨æ•°ç»„æœ«å°¾æ·»åŠ ä¸€ä¸ªå…ƒç´ å³å¯ï¼›å½“å®¹é‡å·²è¾¾åˆ°æé™å¹¶ä¸”éœ€è¦æ‰©å®¹æ—¶ï¼Œåˆ™éœ€è¦æ‰§è¡Œä¸€æ¬¡ O(n) çš„æ“ä½œå°†åŸæ•°ç»„å¤åˆ¶åˆ°æ–°çš„æ›´å¤§çš„æ•°ç»„ä¸­ï¼Œç„¶åå†æ‰§è¡Œ O(1) çš„æ“ä½œæ·»åŠ å…ƒç´ ã€‚
- æŒ‡å®šä½ç½®æ’å…¥ï¼šéœ€è¦å°†ç›®æ ‡ä½ç½®ä¹‹åçš„æ‰€æœ‰å…ƒç´ éƒ½å‘åç§»åŠ¨ä¸€ä¸ªä½ç½®ï¼Œç„¶åå†æŠŠæ–°å…ƒç´ æ”¾å…¥æŒ‡å®šä½ç½®ã€‚è¿™ä¸ªè¿‡ç¨‹éœ€è¦ç§»åŠ¨å¹³å‡ n/2 ä¸ªå…ƒç´ ï¼Œå› æ­¤æ—¶é—´å¤æ‚åº¦ä¸º O(n)ã€‚

å¯¹äºåˆ é™¤ï¼š

- å¤´éƒ¨åˆ é™¤ï¼šç”±äºéœ€è¦å°†æ‰€æœ‰å…ƒç´ ä¾æ¬¡å‘å‰ç§»åŠ¨ä¸€ä¸ªä½ç½®ï¼Œå› æ­¤æ—¶é—´å¤æ‚åº¦æ˜¯ O(n)ã€‚
- å°¾éƒ¨åˆ é™¤ï¼šå½“åˆ é™¤çš„å…ƒç´ ä½äºåˆ—è¡¨æœ«å°¾æ—¶ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º O(1)ã€‚
- æŒ‡å®šä½ç½®åˆ é™¤ï¼šéœ€è¦å°†ç›®æ ‡å…ƒç´ ä¹‹åçš„æ‰€æœ‰å…ƒç´ å‘å‰ç§»åŠ¨ä¸€ä¸ªä½ç½®ä»¥å¡«è¡¥è¢«åˆ é™¤çš„ç©ºç™½ä½ç½®ï¼Œå› æ­¤éœ€è¦ç§»åŠ¨å¹³å‡ n/2 ä¸ªå…ƒç´ ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º O(n)ã€‚

è¿™é‡Œç®€å•åˆ—ä¸¾ä¸€ä¸ªä¾‹å­ï¼š

```java
// ArrayListçš„åº•å±‚æ•°ç»„å¤§å°ä¸º10ï¼Œæ­¤æ—¶å­˜å‚¨äº†7ä¸ªå…ƒç´ 
+---+---+---+---+---+---+---+---+---+---+
| 1 | 2 | 3 | 4 | 5 | 6 | 7 |   |   |   |
+---+---+---+---+---+---+---+---+---+---+
  0   1   2   3   4   5   6   7   8   9
// åœ¨ç´¢å¼•ä¸º1çš„ä½ç½®æ’å…¥ä¸€ä¸ªå…ƒç´ 8ï¼Œè¯¥å…ƒç´ åé¢çš„æ‰€æœ‰å…ƒç´ éƒ½è¦å‘å³ç§»åŠ¨ä¸€ä½
+---+---+---+---+---+---+---+---+---+---+
| 1 | 8 | 2 | 3 | 4 | 5 | 6 | 7 |   |   |
+---+---+---+---+---+---+---+---+---+---+
  0   1   2   3   4   5   6   7   8   9
// åˆ é™¤ç´¢å¼•ä¸º1çš„ä½ç½®çš„å…ƒç´ ï¼Œè¯¥å…ƒç´ åé¢çš„æ‰€æœ‰å…ƒç´ éƒ½è¦å‘å·¦ç§»åŠ¨ä¸€ä½
+---+---+---+---+---+---+---+---+---+---+
| 1 | 2 | 3 | 4 | 5 | 6 | 7 |   |   |   |
+---+---+---+---+---+---+---+---+---+---+
  0   1   2   3   4   5   6   7   8   9
```


### LinkedList ä¸ºä»€ä¹ˆä¸èƒ½å®ç° RandomAccess æ¥å£ï¼Ÿ

`RandomAccess` æ˜¯ä¸€ä¸ªæ ‡è®°æ¥å£ï¼Œç”¨æ¥è¡¨æ˜å®ç°è¯¥æ¥å£çš„ç±»æ”¯æŒéšæœºè®¿é—®ï¼ˆå³å¯ä»¥é€šè¿‡ç´¢å¼•å¿«é€Ÿè®¿é—®å…ƒç´ ï¼‰ã€‚ç”±äº `LinkedList` åº•å±‚æ•°æ®ç»“æ„æ˜¯é“¾è¡¨ï¼Œå†…å­˜åœ°å€ä¸è¿ç»­ï¼Œåªèƒ½é€šè¿‡æŒ‡é’ˆæ¥å®šä½ï¼Œä¸æ”¯æŒéšæœºå¿«é€Ÿè®¿é—®ï¼Œæ‰€ä»¥ä¸èƒ½å®ç° `RandomAccess` æ¥å£ã€‚

### ArrayList ä¸ LinkedList åŒºåˆ«?

- **æ˜¯å¦ä¿è¯çº¿ç¨‹å®‰å…¨ï¼š** `ArrayList` å’Œ `LinkedList` éƒ½æ˜¯ä¸åŒæ­¥çš„ï¼Œä¹Ÿå°±æ˜¯ä¸ä¿è¯çº¿ç¨‹å®‰å…¨ï¼›
- **åº•å±‚æ•°æ®ç»“æ„ï¼š** `ArrayList` åº•å±‚ä½¿ç”¨çš„æ˜¯ **`Object` æ•°ç»„**ï¼›`LinkedList` åº•å±‚ä½¿ç”¨çš„æ˜¯ **åŒå‘é“¾è¡¨** æ•°æ®ç»“æ„ï¼ˆJDK1.6 ä¹‹å‰ä¸ºå¾ªç¯é“¾è¡¨ï¼ŒJDK1.7 å–æ¶ˆäº†å¾ªç¯ã€‚æ³¨æ„åŒå‘é“¾è¡¨å’ŒåŒå‘å¾ªç¯é“¾è¡¨çš„åŒºåˆ«ï¼Œä¸‹é¢æœ‰ä»‹ç»åˆ°ï¼ï¼‰
- **æ’å…¥å’Œåˆ é™¤æ˜¯å¦å—å…ƒç´ ä½ç½®çš„å½±å“ï¼š**
    - `ArrayList` é‡‡ç”¨æ•°ç»„å­˜å‚¨ï¼Œæ‰€ä»¥æ’å…¥å’Œåˆ é™¤å…ƒç´ çš„æ—¶é—´å¤æ‚åº¦å—å…ƒç´ ä½ç½®çš„å½±å“ã€‚ æ¯”å¦‚ï¼šæ‰§è¡Œ`add(E e)`æ–¹æ³•çš„æ—¶å€™ï¼Œ `ArrayList` ä¼šé»˜è®¤åœ¨å°†æŒ‡å®šçš„å…ƒç´ è¿½åŠ åˆ°æ­¤åˆ—è¡¨çš„æœ«å°¾ï¼Œè¿™ç§æƒ…å†µæ—¶é—´å¤æ‚åº¦å°±æ˜¯ O(1)ã€‚ä½†æ˜¯å¦‚æœè¦åœ¨æŒ‡å®šä½ç½® i æ’å…¥å’Œåˆ é™¤å…ƒç´ çš„è¯ï¼ˆ`add(int index, E element)`ï¼‰ï¼Œæ—¶é—´å¤æ‚åº¦å°±ä¸º O(n)ã€‚å› ä¸ºåœ¨è¿›è¡Œä¸Šè¿°æ“ä½œçš„æ—¶å€™é›†åˆä¸­ç¬¬ i å’Œç¬¬ i ä¸ªå…ƒç´ ä¹‹åçš„(n-i)ä¸ªå…ƒç´ éƒ½è¦æ‰§è¡Œå‘åä½/å‘å‰ç§»ä¸€ä½çš„æ“ä½œã€‚
    - `LinkedList` é‡‡ç”¨é“¾è¡¨å­˜å‚¨ï¼Œæ‰€ä»¥åœ¨å¤´å°¾æ’å…¥æˆ–è€…åˆ é™¤å…ƒç´ ä¸å—å…ƒç´ ä½ç½®çš„å½±å“ï¼ˆ`add(E e)`ã€`addFirst(E e)`ã€`addLast(E e)`ã€`removeFirst()`ã€ `removeLast()`ï¼‰ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º O(1)ï¼Œå¦‚æœæ˜¯è¦åœ¨æŒ‡å®šä½ç½® `i` æ’å…¥å’Œåˆ é™¤å…ƒç´ çš„è¯ï¼ˆ`add(int index, E element)`ï¼Œ`remove(Object o)`,`remove(int index)`ï¼‰ï¼Œ æ—¶é—´å¤æ‚åº¦ä¸º O(n) ï¼Œå› ä¸ºéœ€è¦å…ˆç§»åŠ¨åˆ°æŒ‡å®šä½ç½®å†æ’å…¥å’Œåˆ é™¤ã€‚
- **æ˜¯å¦æ”¯æŒå¿«é€Ÿéšæœºè®¿é—®ï¼š** `LinkedList` ä¸æ”¯æŒé«˜æ•ˆçš„éšæœºå…ƒç´ è®¿é—®ï¼Œè€Œ `ArrayList`ï¼ˆå®ç°äº† `RandomAccess` æ¥å£ï¼‰ æ”¯æŒã€‚å¿«é€Ÿéšæœºè®¿é—®å°±æ˜¯é€šè¿‡å…ƒç´ çš„åºå·å¿«é€Ÿè·å–å…ƒç´ å¯¹è±¡(å¯¹åº”äº`get(int index)`æ–¹æ³•)ã€‚
- **å†…å­˜ç©ºé—´å ç”¨ï¼š** `ArrayList` çš„ç©ºé—´æµªè´¹ä¸»è¦ä½“ç°åœ¨åœ¨ list åˆ—è¡¨çš„ç»“å°¾ä¼šé¢„ç•™ä¸€å®šçš„å®¹é‡ç©ºé—´ï¼Œè€Œ LinkedList çš„ç©ºé—´èŠ±è´¹åˆ™ä½“ç°åœ¨å®ƒçš„æ¯ä¸€ä¸ªå…ƒç´ éƒ½éœ€è¦æ¶ˆè€—æ¯” ArrayList æ›´å¤šçš„ç©ºé—´ï¼ˆå› ä¸ºè¦å­˜æ”¾ç›´æ¥åç»§å’Œç›´æ¥å‰é©±ä»¥åŠæ•°æ®ï¼‰ã€‚

æˆ‘ä»¬åœ¨é¡¹ç›®ä¸­ä¸€èˆ¬æ˜¯ä¸ä¼šä½¿ç”¨åˆ° `LinkedList` çš„ï¼Œéœ€è¦ç”¨åˆ° `LinkedList` çš„åœºæ™¯å‡ ä¹éƒ½å¯ä»¥ä½¿ç”¨ `ArrayList` æ¥ä»£æ›¿ï¼Œå¹¶ä¸”ï¼Œæ€§èƒ½é€šå¸¸ä¼šæ›´å¥½ï¼å°±è¿ `LinkedList` çš„ä½œè€…çº¦ä¹¦äºš Â· å¸ƒæ´›å…‹ï¼ˆJosh Blochï¼‰è‡ªå·±éƒ½è¯´ä»æ¥ä¸ä¼šä½¿ç”¨ `LinkedList` ã€‚

![img.png](images/img.png)


### è¯´ä¸€è¯´ ArrayList çš„æ‰©å®¹æœºåˆ¶å§

è¯¦è§ç¬”ä¸»çš„è¿™ç¯‡æ–‡ç« : [ArrayList æ‰©å®¹æœºåˆ¶åˆ†æ](https://javaguide.cn/java/collection/arraylist-source-code.html#_3-1-%E5%85%88%E4%BB%8E-arraylist-%E7%9A%84%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0%E8%AF%B4%E8%B5%B7)ã€‚


### Comparable å’Œ Comparator çš„åŒºåˆ«

`Comparable` æ¥å£å’Œ `Comparator` æ¥å£éƒ½æ˜¯ Java ä¸­ç”¨äºæ’åºçš„æ¥å£ï¼Œå®ƒä»¬åœ¨å®ç°ç±»å¯¹è±¡ä¹‹é—´æ¯”è¾ƒå¤§å°ã€æ’åºç­‰æ–¹é¢å‘æŒ¥äº†é‡è¦ä½œç”¨ï¼š

- `Comparable` æ¥å£å®é™…ä¸Šæ˜¯å‡ºè‡ª`java.lang`åŒ… å®ƒæœ‰ä¸€ä¸ª `compareTo(Object obj)`æ–¹æ³•ç”¨æ¥æ’åº
- `Comparator`æ¥å£å®é™…ä¸Šæ˜¯å‡ºè‡ª `java.util` åŒ…å®ƒæœ‰ä¸€ä¸ª`compare(Object obj1, Object obj2)`æ–¹æ³•ç”¨æ¥æ’åº

ä¸€èˆ¬æˆ‘ä»¬éœ€è¦å¯¹ä¸€ä¸ªé›†åˆä½¿ç”¨è‡ªå®šä¹‰æ’åºæ—¶ï¼Œæˆ‘ä»¬å°±è¦é‡å†™`compareTo()`æ–¹æ³•æˆ–`compare()`æ–¹æ³•ï¼Œå½“æˆ‘ä»¬éœ€è¦å¯¹æŸä¸€ä¸ªé›†åˆå®ç°ä¸¤ç§æ’åºæ–¹å¼ï¼Œæ¯”å¦‚ä¸€ä¸ª `song` å¯¹è±¡ä¸­çš„æ­Œåå’Œæ­Œæ‰‹ååˆ†åˆ«é‡‡ç”¨ä¸€ç§æ’åºæ–¹æ³•çš„è¯ï¼Œæˆ‘ä»¬å¯ä»¥é‡å†™`compareTo()`æ–¹æ³•å’Œä½¿ç”¨è‡ªåˆ¶çš„`Comparator`æ–¹æ³•æˆ–è€…ä»¥ä¸¤ä¸ª `Comparator` æ¥å®ç°æ­Œåæ’åºå’Œæ­Œæ˜Ÿåæ’åºï¼Œç¬¬äºŒç§ä»£è¡¨æˆ‘ä»¬åªèƒ½ä½¿ç”¨ä¸¤ä¸ªå‚æ•°ç‰ˆçš„ `Collections.sort()`.




### Queue ä¸ Deque çš„åŒºåˆ« 

â˜…

| \ | æ’åº | å¯å¦é‡å¤ | ç‰¹ç‚¹   | æ˜¯å¦å¯ä»¥æ’å…¥null | 
|---| ---- | -------- | ------ | ---------------- |
| Queue | å¦ | æ˜¯ | å•ç«¯é˜Ÿåˆ— | å¦ |
| Deque | å¦ | æ˜¯ | åŒç«¯é˜Ÿåˆ— | å¦ |
| BlockingQueue | å¦ | æ˜¯ | é˜»å¡é˜Ÿåˆ— | å¦ |

â˜†

| \ | æ’åº | å¯å¦é‡å¤ | ç‰¹ç‚¹   | æ˜¯å¦å¯ä»¥æ’å…¥null |
|---| ---- | -------- | ------ | ---------------- |
| PriorityQueue | æ˜¯ | æ˜¯ | ä¼˜å…ˆé˜Ÿåˆ— | å¦ |
| ArrayDeque | å¦ | æ˜¯ | åŒç«¯é˜Ÿåˆ— | å¦ |
| LinkedList | å¦ | æ˜¯ | åŒç«¯é˜Ÿåˆ— | æ˜¯ |
| LinkedBlockingQueue | å¦ | æ˜¯ | é˜»å¡é˜Ÿåˆ— | å¦ |
| ArrayBlockingQueue | å¦ | æ˜¯ | é˜»å¡é˜Ÿåˆ— | å¦ |
| PriorityBlockingQueue | æ˜¯ | æ˜¯ | ä¼˜å…ˆé˜Ÿåˆ— | å¦ |
|DelayQueue | æ˜¯ | æ˜¯ | å»¶è¿Ÿé˜Ÿåˆ— | å¦ |

![img_1.png](images/img_1.png)


### HashMap çš„åº•å±‚å®ç° â˜…

#### JDK1.8 ä¹‹å‰

JDK1.8 ä¹‹å‰ `HashMap` åº•å±‚æ˜¯ **æ•°ç»„å’Œé“¾è¡¨** ç»“åˆåœ¨ä¸€èµ·ä½¿ç”¨ä¹Ÿå°±æ˜¯ **é“¾è¡¨æ•£åˆ—**ã€‚HashMap é€šè¿‡ key çš„ `hashcode` ç»è¿‡æ‰°åŠ¨å‡½æ•°å¤„ç†è¿‡åå¾—åˆ° hash å€¼ï¼Œç„¶åé€šè¿‡ `(n - 1) & hash` åˆ¤æ–­å½“å‰å…ƒç´ å­˜æ”¾çš„ä½ç½®ï¼ˆè¿™é‡Œçš„ n æŒ‡çš„æ˜¯æ•°ç»„çš„é•¿åº¦ï¼‰ï¼Œå¦‚æœå½“å‰ä½ç½®å­˜åœ¨å…ƒç´ çš„è¯ï¼Œå°±åˆ¤æ–­è¯¥å…ƒç´ ä¸è¦å­˜å…¥çš„å…ƒç´ çš„ hash å€¼ä»¥åŠ key æ˜¯å¦ç›¸åŒï¼Œå¦‚æœç›¸åŒçš„è¯ï¼Œç›´æ¥è¦†ç›–ï¼Œä¸ç›¸åŒå°±é€šè¿‡æ‹‰é“¾æ³•è§£å†³å†²çªã€‚

æ‰€è°“æ‰°åŠ¨å‡½æ•°æŒ‡çš„å°±æ˜¯ HashMap çš„ `hash` æ–¹æ³•ã€‚ä½¿ç”¨ `hash` æ–¹æ³•ä¹Ÿå°±æ˜¯æ‰°åŠ¨å‡½æ•°æ˜¯ä¸ºäº†é˜²æ­¢ä¸€äº›å®ç°æ¯”è¾ƒå·®çš„ `hashCode()` æ–¹æ³• æ¢å¥è¯è¯´ä½¿ç”¨æ‰°åŠ¨å‡½æ•°ä¹‹åå¯ä»¥å‡å°‘ç¢°æ’ã€‚

**JDK 1.8 HashMap çš„ hash æ–¹æ³•æºç :**

JDK 1.8 çš„ hash æ–¹æ³• ç›¸æ¯”äº JDK 1.7 hash æ–¹æ³•æ›´åŠ ç®€åŒ–ï¼Œä½†æ˜¯åŸç†ä¸å˜ã€‚

```java
    static final int hash(Object key) {
      int h;
      // key.hashCode()ï¼šè¿”å›æ•£åˆ—å€¼ä¹Ÿå°±æ˜¯hashcode
      // ^ï¼šæŒ‰ä½å¼‚æˆ–
      // >>>:æ— ç¬¦å·å³ç§»ï¼Œå¿½ç•¥ç¬¦å·ä½ï¼Œç©ºä½éƒ½ä»¥0è¡¥é½
      return (key == null) ? 0 : (h = key.hashCode()) ^ (h >>> 16);
  }
```

å¯¹æ¯”ä¸€ä¸‹ JDK1.7 çš„ HashMap çš„ hash æ–¹æ³•æºç .

```java
static int hash(int h) {
    // This function ensures that hashCodes that differ only by
    // constant multiples at each bit position have a bounded
    // number of collisions (approximately 8 at default load factor).

    h ^= (h >>> 20) ^ (h >>> 12);
    return h ^ (h >>> 7) ^ (h >>> 4);
}
```

ç›¸æ¯”äº JDK1.8 çš„ hash æ–¹æ³• ï¼ŒJDK 1.7 çš„ hash æ–¹æ³•çš„æ€§èƒ½ä¼šç¨å·®ä¸€ç‚¹ç‚¹ï¼Œå› ä¸ºæ¯•ç«Ÿæ‰°åŠ¨äº† 4 æ¬¡ã€‚

æ‰€è°“ **â€œæ‹‰é“¾æ³•â€** å°±æ˜¯ï¼šå°†é“¾è¡¨å’Œæ•°ç»„ç›¸ç»“åˆã€‚ä¹Ÿå°±æ˜¯è¯´åˆ›å»ºä¸€ä¸ªé“¾è¡¨æ•°ç»„ï¼Œæ•°ç»„ä¸­æ¯ä¸€æ ¼å°±æ˜¯ä¸€ä¸ªé“¾è¡¨ã€‚è‹¥é‡åˆ°å“ˆå¸Œå†²çªï¼Œåˆ™å°†å†²çªçš„å€¼åŠ åˆ°é“¾è¡¨ä¸­å³å¯ã€‚

![img_2.png](images/img_2.png)

#### JDK1.8 ä¹‹å

ç›¸æ¯”äºä¹‹å‰çš„ç‰ˆæœ¬ï¼Œ JDK1.8 ä¹‹ååœ¨è§£å†³å“ˆå¸Œå†²çªæ—¶æœ‰äº†è¾ƒå¤§çš„å˜åŒ–ï¼Œå½“é“¾è¡¨é•¿åº¦å¤§äºé˜ˆå€¼ï¼ˆé»˜è®¤ä¸º 8ï¼‰ï¼ˆå°†é“¾è¡¨è½¬æ¢æˆçº¢é»‘æ ‘å‰ä¼šåˆ¤æ–­ï¼Œå¦‚æœå½“å‰æ•°ç»„çš„é•¿åº¦å°äº 64ï¼Œé‚£ä¹ˆä¼šé€‰æ‹©å…ˆè¿›è¡Œæ•°ç»„æ‰©å®¹ï¼Œè€Œä¸æ˜¯è½¬æ¢ä¸ºçº¢é»‘æ ‘ï¼‰æ—¶ï¼Œå°†é“¾è¡¨è½¬åŒ–ä¸ºçº¢é»‘æ ‘ï¼Œä»¥å‡å°‘æœç´¢æ—¶é—´ã€‚

![img.png](images/img233.png)

> TreeMapã€TreeSet ä»¥åŠ JDK1.8 ä¹‹åçš„ HashMap åº•å±‚éƒ½ç”¨åˆ°äº†çº¢é»‘æ ‘ã€‚çº¢é»‘æ ‘å°±æ˜¯ä¸ºäº†è§£å†³äºŒå‰æŸ¥æ‰¾æ ‘çš„ç¼ºé™·ï¼Œå› ä¸ºäºŒå‰æŸ¥æ‰¾æ ‘åœ¨æŸäº›æƒ…å†µä¸‹ä¼šé€€åŒ–æˆä¸€ä¸ªçº¿æ€§ç»“æ„ã€‚

æˆ‘ä»¬æ¥ç»“åˆæºç åˆ†æä¸€ä¸‹ `HashMap` é“¾è¡¨åˆ°çº¢é»‘æ ‘çš„è½¬æ¢ã€‚

**1ã€ `putVal` æ–¹æ³•ä¸­æ‰§è¡Œé“¾è¡¨è½¬çº¢é»‘æ ‘çš„åˆ¤æ–­é€»è¾‘ã€‚**

é“¾è¡¨çš„é•¿åº¦å¤§äº 8 çš„æ—¶å€™ï¼Œå°±æ‰§è¡Œ `treeifyBin` ï¼ˆè½¬æ¢çº¢é»‘æ ‘ï¼‰çš„é€»è¾‘ã€‚

```java
// éå†é“¾è¡¨
for (int binCount = 0; ; ++binCount) {
    // éå†åˆ°é“¾è¡¨æœ€åä¸€ä¸ªèŠ‚ç‚¹
    if ((e = p.next) == null) {
        p.next = newNode(hash, key, value, null);
        // å¦‚æœé“¾è¡¨å…ƒç´ ä¸ªæ•°å¤§äºç­‰äºTREEIFY_THRESHOLDï¼ˆ8ï¼‰
        if (binCount >= TREEIFY_THRESHOLD - 1) // -1 for 1st
            // çº¢é»‘æ ‘è½¬æ¢ï¼ˆå¹¶ä¸ä¼šç›´æ¥è½¬æ¢æˆçº¢é»‘æ ‘ï¼‰
            treeifyBin(tab, hash);
        break;
    }
    if (e.hash == hash &&
        ((k = e.key) == key || (key != null && key.equals(k))))
        break;
    p = e;
}
```

**2ã€`treeifyBin` æ–¹æ³•ä¸­åˆ¤æ–­æ˜¯å¦çœŸçš„è½¬æ¢ä¸ºçº¢é»‘æ ‘ã€‚**

```java
final void treeifyBin(Node<K,V>[] tab, int hash) {
    int n, index; Node<K,V> e;
    // åˆ¤æ–­å½“å‰æ•°ç»„çš„é•¿åº¦æ˜¯å¦å°äº 64
    if (tab == null || (n = tab.length) < MIN_TREEIFY_CAPACITY)
        // å¦‚æœå½“å‰æ•°ç»„çš„é•¿åº¦å°äº 64ï¼Œé‚£ä¹ˆä¼šé€‰æ‹©å…ˆè¿›è¡Œæ•°ç»„æ‰©å®¹
        resize();
    else if ((e = tab[index = (n - 1) & hash]) != null) {
        // å¦åˆ™æ‰å°†åˆ—è¡¨è½¬æ¢ä¸ºçº¢é»‘æ ‘

        TreeNode<K,V> hd = null, tl = null;
        do {
            TreeNode<K,V> p = replacementTreeNode(e, null);
            if (tl == null)
                hd = p;
            else {
                p.prev = tl;
                tl.next = p;
            }
            tl = p;
        } while ((e = e.next) != null);
        if ((tab[index] = hd) != null)
            hd.treeify(tab);
    }
}
```

å°†é“¾è¡¨è½¬æ¢æˆçº¢é»‘æ ‘å‰ä¼šåˆ¤æ–­ï¼Œå¦‚æœå½“å‰æ•°ç»„çš„é•¿åº¦å°äº 64ï¼Œé‚£ä¹ˆä¼šé€‰æ‹©å…ˆè¿›è¡Œæ•°ç»„æ‰©å®¹ï¼Œè€Œä¸æ˜¯è½¬æ¢ä¸ºçº¢é»‘æ ‘ã€‚

### HashMap çš„é•¿åº¦ä¸ºä»€ä¹ˆæ˜¯ 2 çš„å¹‚æ¬¡æ–¹

ä¸ºäº†èƒ½è®© HashMap å­˜å–é«˜æ•ˆï¼Œå°½é‡è¾ƒå°‘ç¢°æ’ï¼Œä¹Ÿå°±æ˜¯è¦å°½é‡æŠŠæ•°æ®åˆ†é…å‡åŒ€ã€‚æˆ‘ä»¬ä¸Šé¢ä¹Ÿè®²åˆ°äº†è¿‡äº†ï¼ŒHash å€¼çš„èŒƒå›´å€¼-2147483648 åˆ° 2147483647ï¼Œå‰ååŠ èµ·æ¥å¤§æ¦‚ 40 äº¿çš„æ˜ å°„ç©ºé—´ï¼Œåªè¦å“ˆå¸Œå‡½æ•°æ˜ å°„å¾—æ¯”è¾ƒå‡åŒ€æ¾æ•£ï¼Œä¸€èˆ¬åº”ç”¨æ˜¯å¾ˆéš¾å‡ºç°ç¢°æ’çš„ã€‚ä½†é—®é¢˜æ˜¯ä¸€ä¸ª 40 äº¿é•¿åº¦çš„æ•°ç»„ï¼Œå†…å­˜æ˜¯æ”¾ä¸ä¸‹çš„ã€‚æ‰€ä»¥è¿™ä¸ªæ•£åˆ—å€¼æ˜¯ä¸èƒ½ç›´æ¥æ‹¿æ¥ç”¨çš„ã€‚ç”¨ä¹‹å‰è¿˜è¦å…ˆåšå¯¹æ•°ç»„çš„é•¿åº¦å–æ¨¡è¿ç®—ï¼Œå¾—åˆ°çš„ä½™æ•°æ‰èƒ½ç”¨æ¥è¦å­˜æ”¾çš„ä½ç½®ä¹Ÿå°±æ˜¯å¯¹åº”çš„æ•°ç»„ä¸‹æ ‡ã€‚è¿™ä¸ªæ•°ç»„ä¸‹æ ‡çš„è®¡ç®—æ–¹æ³•æ˜¯â€œ `(n - 1) & hash`â€ã€‚ï¼ˆn ä»£è¡¨æ•°ç»„é•¿åº¦ï¼‰ã€‚è¿™ä¹Ÿå°±è§£é‡Šäº† HashMap çš„é•¿åº¦ä¸ºä»€ä¹ˆæ˜¯ 2 çš„å¹‚æ¬¡æ–¹ã€‚

**è¿™ä¸ªç®—æ³•åº”è¯¥å¦‚ä½•è®¾è®¡å‘¢ï¼Ÿ**

æˆ‘ä»¬é¦–å…ˆå¯èƒ½ä¼šæƒ³åˆ°é‡‡ç”¨%å–ä½™çš„æ“ä½œæ¥å®ç°ã€‚ä½†æ˜¯ï¼Œé‡ç‚¹æ¥äº†ï¼š**â€œå–ä½™(%)æ“ä½œä¸­å¦‚æœé™¤æ•°æ˜¯ 2 çš„å¹‚æ¬¡åˆ™ç­‰ä»·äºä¸å…¶é™¤æ•°å‡ä¸€çš„ä¸(&)æ“ä½œï¼ˆä¹Ÿå°±æ˜¯è¯´ hash%length==hash&(length-1)çš„å‰ææ˜¯ length æ˜¯ 2 çš„ n æ¬¡æ–¹ï¼›ï¼‰ã€‚â€** å¹¶ä¸” **é‡‡ç”¨äºŒè¿›åˆ¶ä½æ“ä½œ &ï¼Œç›¸å¯¹äº%èƒ½å¤Ÿæé«˜è¿ç®—æ•ˆç‡ï¼Œè¿™å°±è§£é‡Šäº† HashMap çš„é•¿åº¦ä¸ºä»€ä¹ˆæ˜¯ 2 çš„å¹‚æ¬¡æ–¹ã€‚**

### HashMap å¤šçº¿ç¨‹æ“ä½œå¯¼è‡´æ­»å¾ªç¯é—®é¢˜

JDK1.7 åŠä¹‹å‰ç‰ˆæœ¬çš„ `HashMap` åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹æ‰©å®¹æ“ä½œå¯èƒ½å­˜åœ¨æ­»å¾ªç¯é—®é¢˜ï¼Œè¿™æ˜¯ç”±äºå½“ä¸€ä¸ªæ¡¶ä½ä¸­æœ‰å¤šä¸ªå…ƒç´ éœ€è¦è¿›è¡Œæ‰©å®¹æ—¶ï¼Œå¤šä¸ªçº¿ç¨‹åŒæ—¶å¯¹é“¾è¡¨è¿›è¡Œæ“ä½œï¼Œå¤´æ’æ³•å¯èƒ½ä¼šå¯¼è‡´é“¾è¡¨ä¸­çš„èŠ‚ç‚¹æŒ‡å‘é”™è¯¯çš„ä½ç½®ï¼Œä»è€Œå½¢æˆä¸€ä¸ªç¯å½¢é“¾è¡¨ï¼Œè¿›è€Œä½¿å¾—æŸ¥è¯¢å…ƒç´ çš„æ“ä½œé™·å…¥æ­»å¾ªç¯æ— æ³•ç»“æŸã€‚

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒJDK1.8 ç‰ˆæœ¬çš„ HashMap é‡‡ç”¨äº†å°¾æ’æ³•è€Œä¸æ˜¯å¤´æ’æ³•æ¥é¿å…é“¾è¡¨å€’ç½®ï¼Œä½¿å¾—æ’å…¥çš„èŠ‚ç‚¹æ°¸è¿œéƒ½æ˜¯æ”¾åœ¨é“¾è¡¨çš„æœ«å°¾ï¼Œé¿å…äº†é“¾è¡¨ä¸­çš„ç¯å½¢ç»“æ„ã€‚ä½†æ˜¯è¿˜æ˜¯ä¸å»ºè®®åœ¨å¤šçº¿ç¨‹ä¸‹ä½¿ç”¨ `HashMap`ï¼Œå› ä¸ºå¤šçº¿ç¨‹ä¸‹ä½¿ç”¨ `HashMap` è¿˜æ˜¯ä¼šå­˜åœ¨æ•°æ®è¦†ç›–çš„é—®é¢˜ã€‚å¹¶å‘ç¯å¢ƒä¸‹ï¼Œæ¨èä½¿ç”¨ `ConcurrentHashMap` ã€‚

ä¸€èˆ¬é¢è¯•ä¸­è¿™æ ·ä»‹ç»å°±å·®ä¸å¤šï¼Œä¸éœ€è¦è®°å„ç§ç»†èŠ‚ï¼Œä¸ªäººè§‰å¾—ä¹Ÿæ²¡å¿…è¦è®°ã€‚å¦‚æœæƒ³è¦è¯¦ç»†äº†è§£ `HashMap` æ‰©å®¹å¯¼è‡´æ­»å¾ªç¯é—®é¢˜ï¼Œå¯ä»¥çœ‹çœ‹è€—å­å”çš„è¿™ç¯‡æ–‡ç« ï¼š[Java HashMap çš„æ­»å¾ªç¯](https://coolshell.cn/articles/9606.html)ã€‚

### HashMap ä¸ºä»€ä¹ˆçº¿ç¨‹ä¸å®‰å…¨ï¼Ÿ

JDK1.7 åŠä¹‹å‰ç‰ˆæœ¬ï¼Œåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œ`HashMap` æ‰©å®¹æ—¶ä¼šé€ æˆæ­»å¾ªç¯å’Œæ•°æ®ä¸¢å¤±çš„é—®é¢˜ã€‚

æ•°æ®ä¸¢å¤±è¿™ä¸ªåœ¨ JDK1.7 å’Œ JDK 1.8 ä¸­éƒ½å­˜åœ¨ï¼Œè¿™é‡Œä»¥ JDK 1.8 ä¸ºä¾‹è¿›è¡Œä»‹ç»ã€‚

JDK 1.8 åï¼Œåœ¨ `HashMap` ä¸­ï¼Œå¤šä¸ªé”®å€¼å¯¹å¯èƒ½ä¼šè¢«åˆ†é…åˆ°åŒä¸€ä¸ªæ¡¶ï¼ˆbucketï¼‰ï¼Œå¹¶ä»¥é“¾è¡¨æˆ–çº¢é»‘æ ‘çš„å½¢å¼å­˜å‚¨ã€‚å¤šä¸ªçº¿ç¨‹å¯¹ `HashMap` çš„ `put` æ“ä½œä¼šå¯¼è‡´çº¿ç¨‹ä¸å®‰å…¨ï¼Œå…·ä½“æ¥è¯´ä¼šæœ‰æ•°æ®è¦†ç›–çš„é£é™©ã€‚

ä¸¾ä¸ªä¾‹å­ï¼š

- ä¸¤ä¸ªçº¿ç¨‹ 1,2 åŒæ—¶è¿›è¡Œ put æ“ä½œï¼Œå¹¶ä¸”å‘ç”Ÿäº†å“ˆå¸Œå†²çªï¼ˆhash å‡½æ•°è®¡ç®—å‡ºçš„æ’å…¥ä¸‹æ ‡æ˜¯ç›¸åŒçš„ï¼‰ã€‚
- ä¸åŒçš„çº¿ç¨‹å¯èƒ½åœ¨ä¸åŒçš„æ—¶é—´ç‰‡è·å¾— CPU æ‰§è¡Œçš„æœºä¼šï¼Œå½“å‰çº¿ç¨‹ 1 æ‰§è¡Œå®Œå“ˆå¸Œå†²çªåˆ¤æ–­åï¼Œç”±äºæ—¶é—´ç‰‡è€—å°½æŒ‚èµ·ã€‚çº¿ç¨‹ 2 å…ˆå®Œæˆäº†æ’å…¥æ“ä½œã€‚
- éšåï¼Œçº¿ç¨‹ 1 è·å¾—æ—¶é—´ç‰‡ï¼Œç”±äºä¹‹å‰å·²ç»è¿›è¡Œè¿‡ hash ç¢°æ’çš„åˆ¤æ–­ï¼Œæ‰€æœ‰æ­¤æ—¶ä¼šç›´æ¥è¿›è¡Œæ’å…¥ï¼Œè¿™å°±å¯¼è‡´çº¿ç¨‹ 2 æ’å…¥çš„æ•°æ®è¢«çº¿ç¨‹ 1 è¦†ç›–äº†ã€‚

```java
public V put(K key, V value) {
    return putVal(hash(key), key, value, false, true);
}

final V putVal(int hash, K key, V value, boolean onlyIfAbsent,
                   boolean evict) {
    // ...
    // åˆ¤æ–­æ˜¯å¦å‡ºç° hash ç¢°æ’
    // (n - 1) & hash ç¡®å®šå…ƒç´ å­˜æ”¾åœ¨å“ªä¸ªæ¡¶ä¸­ï¼Œæ¡¶ä¸ºç©ºï¼Œæ–°ç”Ÿæˆç»“ç‚¹æ”¾å…¥æ¡¶ä¸­(æ­¤æ—¶ï¼Œè¿™ä¸ªç»“ç‚¹æ˜¯æ”¾åœ¨æ•°ç»„ä¸­)
    if ((p = tab[i = (n - 1) & hash]) == null)
        tab[i] = newNode(hash, key, value, null);
    // æ¡¶ä¸­å·²ç»å­˜åœ¨å…ƒç´ ï¼ˆå¤„ç†hashå†²çªï¼‰
    else {
    // ...
}
```

è¿˜æœ‰ä¸€ç§æƒ…å†µæ˜¯è¿™ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶ `put` æ“ä½œå¯¼è‡´ `size` çš„å€¼ä¸æ­£ç¡®ï¼Œè¿›è€Œå¯¼è‡´æ•°æ®è¦†ç›–çš„é—®é¢˜ï¼š

1. çº¿ç¨‹ 1 æ‰§è¡Œ `if(++size > threshold)` åˆ¤æ–­æ—¶ï¼Œå‡è®¾è·å¾— `size` çš„å€¼ä¸º 10ï¼Œç”±äºæ—¶é—´ç‰‡è€—å°½æŒ‚èµ·ã€‚
2. çº¿ç¨‹ 2 ä¹Ÿæ‰§è¡Œ `if(++size > threshold)` åˆ¤æ–­ï¼Œè·å¾— `size` çš„å€¼ä¹Ÿä¸º 10ï¼Œå¹¶å°†å…ƒç´ æ’å…¥åˆ°è¯¥æ¡¶ä½ä¸­ï¼Œå¹¶å°† `size` çš„å€¼æ›´æ–°ä¸º 11ã€‚
3. éšåï¼Œçº¿ç¨‹ 1 è·å¾—æ—¶é—´ç‰‡ï¼Œå®ƒä¹Ÿå°†å…ƒç´ æ”¾å…¥æ¡¶ä½ä¸­ï¼Œå¹¶å°† size çš„å€¼æ›´æ–°ä¸º 11ã€‚
4. çº¿ç¨‹ 1ã€2 éƒ½æ‰§è¡Œäº†ä¸€æ¬¡ `put` æ“ä½œï¼Œä½†æ˜¯ `size` çš„å€¼åªå¢åŠ äº† 1ï¼Œä¹Ÿå°±å¯¼è‡´å®é™…ä¸Šåªæœ‰ä¸€ä¸ªå…ƒç´ è¢«æ·»åŠ åˆ°äº† `HashMap` ä¸­ã€‚

```java
public V put(K key, V value) {
    return putVal(hash(key), key, value, false, true);
}

final V putVal(int hash, K key, V value, boolean onlyIfAbsent,
                   boolean evict) {
    // ...
    // å®é™…å¤§å°å¤§äºé˜ˆå€¼åˆ™æ‰©å®¹
    if (++size > threshold)
        resize();
    // æ’å…¥åå›è°ƒ
    afterNodeInsertion(evict);
    return null;
}
```

### HashMap å¸¸è§çš„éå†æ–¹å¼?

[HashMap çš„ 7 ç§éå†æ–¹å¼ä¸æ€§èƒ½åˆ†æï¼](https://mp.weixin.qq.com/s/zQBN3UvJDhRTKP6SzcZFKw)

**ğŸ› ä¿®æ­£ï¼ˆå‚è§ï¼š[issue#1411](https://github.com/Snailclimb/JavaGuide/issues/1411)ï¼‰**ï¼š

è¿™ç¯‡æ–‡ç« å¯¹äº parallelStream éå†æ–¹å¼çš„æ€§èƒ½åˆ†ææœ‰è¯¯ï¼Œå…ˆè¯´ç»“è®ºï¼š**å­˜åœ¨é˜»å¡æ—¶ parallelStream æ€§èƒ½æœ€é«˜, éé˜»å¡æ—¶ parallelStream æ€§èƒ½æœ€ä½** ã€‚

å½“éå†ä¸å­˜åœ¨é˜»å¡æ—¶, parallelStream çš„æ€§èƒ½æ˜¯æœ€ä½çš„ï¼š

```
Benchmark               Mode  Cnt     Score      Error  Units
Test.entrySet           avgt    5   288.651 Â±   10.536  ns/op
Test.keySet             avgt    5   584.594 Â±   21.431  ns/op
Test.lambda             avgt    5   221.791 Â±   10.198  ns/op
Test.parallelStream     avgt    5  6919.163 Â± 1116.139  ns/op
```

åŠ å…¥é˜»å¡ä»£ç `Thread.sleep(10)`å, parallelStream çš„æ€§èƒ½æ‰æ˜¯æœ€é«˜çš„:

```
Benchmark               Mode  Cnt           Score          Error  Units
Test.entrySet           avgt    5  1554828440.000 Â± 23657748.653  ns/op
Test.keySet             avgt    5  1550612500.000 Â±  6474562.858  ns/op
Test.lambda             avgt    5  1551065180.000 Â± 19164407.426  ns/op
Test.parallelStream     avgt    5   186345456.667 Â±  3210435.590  ns/op
```

### ConcurrentHashMap å’Œ Hashtable çš„åŒºåˆ«

`ConcurrentHashMap` å’Œ `Hashtable` çš„åŒºåˆ«ä¸»è¦ä½“ç°åœ¨å®ç°çº¿ç¨‹å®‰å…¨çš„æ–¹å¼ä¸Šä¸åŒã€‚

- **åº•å±‚æ•°æ®ç»“æ„ï¼š** JDK1.7 çš„ `ConcurrentHashMap` åº•å±‚é‡‡ç”¨ **åˆ†æ®µçš„æ•°ç»„+é“¾è¡¨** å®ç°ï¼ŒJDK1.8 é‡‡ç”¨çš„æ•°æ®ç»“æ„è·Ÿ `HashMap1.8` çš„ç»“æ„ä¸€æ ·ï¼Œæ•°ç»„+é“¾è¡¨/çº¢é»‘äºŒå‰æ ‘ã€‚`Hashtable` å’Œ JDK1.8 ä¹‹å‰çš„ `HashMap` çš„åº•å±‚æ•°æ®ç»“æ„ç±»ä¼¼éƒ½æ˜¯é‡‡ç”¨ **æ•°ç»„+é“¾è¡¨** çš„å½¢å¼ï¼Œæ•°ç»„æ˜¯ HashMap çš„ä¸»ä½“ï¼Œé“¾è¡¨åˆ™æ˜¯ä¸»è¦ä¸ºäº†è§£å†³å“ˆå¸Œå†²çªè€Œå­˜åœ¨çš„ï¼›
- **å®ç°çº¿ç¨‹å®‰å…¨çš„æ–¹å¼ï¼ˆé‡è¦ï¼‰ï¼š**
  - åœ¨ JDK1.7 çš„æ—¶å€™ï¼Œ`ConcurrentHashMap` å¯¹æ•´ä¸ªæ¡¶æ•°ç»„è¿›è¡Œäº†åˆ†å‰²åˆ†æ®µ(`Segment`ï¼Œåˆ†æ®µé”)ï¼Œæ¯ä¸€æŠŠé”åªé”å®¹å™¨å…¶ä¸­ä¸€éƒ¨åˆ†æ•°æ®ï¼ˆä¸‹é¢æœ‰ç¤ºæ„å›¾ï¼‰ï¼Œå¤šçº¿ç¨‹è®¿é—®å®¹å™¨é‡Œä¸åŒæ•°æ®æ®µçš„æ•°æ®ï¼Œå°±ä¸ä¼šå­˜åœ¨é”ç«äº‰ï¼Œæé«˜å¹¶å‘è®¿é—®ç‡ã€‚
  - åˆ°äº† JDK1.8 çš„æ—¶å€™ï¼Œ`ConcurrentHashMap` å·²ç»æ‘’å¼ƒäº† `Segment` çš„æ¦‚å¿µï¼Œè€Œæ˜¯ç›´æ¥ç”¨ `Node` æ•°ç»„+é“¾è¡¨+çº¢é»‘æ ‘çš„æ•°æ®ç»“æ„æ¥å®ç°ï¼Œå¹¶å‘æ§åˆ¶ä½¿ç”¨ `synchronized` å’Œ CAS æ¥æ“ä½œã€‚ï¼ˆJDK1.6 ä»¥å `synchronized` é”åšäº†å¾ˆå¤šä¼˜åŒ–ï¼‰ æ•´ä¸ªçœ‹èµ·æ¥å°±åƒæ˜¯ä¼˜åŒ–è¿‡ä¸”çº¿ç¨‹å®‰å…¨çš„ `HashMap`ï¼Œè™½ç„¶åœ¨ JDK1.8 ä¸­è¿˜èƒ½çœ‹åˆ° `Segment` çš„æ•°æ®ç»“æ„ï¼Œä½†æ˜¯å·²ç»ç®€åŒ–äº†å±æ€§ï¼Œåªæ˜¯ä¸ºäº†å…¼å®¹æ—§ç‰ˆæœ¬ï¼›
  - **`Hashtable`(åŒä¸€æŠŠé”)** :ä½¿ç”¨ `synchronized` æ¥ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œæ•ˆç‡éå¸¸ä½ä¸‹ã€‚å½“ä¸€ä¸ªçº¿ç¨‹è®¿é—®åŒæ­¥æ–¹æ³•æ—¶ï¼Œå…¶ä»–çº¿ç¨‹ä¹Ÿè®¿é—®åŒæ­¥æ–¹æ³•ï¼Œå¯èƒ½ä¼šè¿›å…¥é˜»å¡æˆ–è½®è¯¢çŠ¶æ€ï¼Œå¦‚ä½¿ç”¨ put æ·»åŠ å…ƒç´ ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹ä¸èƒ½ä½¿ç”¨ put æ·»åŠ å…ƒç´ ï¼Œä¹Ÿä¸èƒ½ä½¿ç”¨ getï¼Œç«äº‰ä¼šè¶Šæ¥è¶Šæ¿€çƒˆæ•ˆç‡è¶Šä½ã€‚

ä¸‹é¢ï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹ä¸¤è€…åº•å±‚æ•°æ®ç»“æ„çš„å¯¹æ¯”å›¾ã€‚

**Hashtable** :

![img_6.png](images%2Fimg_6.png)
<p style="text-align:right;font-size:13px;color:gray">https://www.cnblogs.com/chengxiao/p/6842045.html></p>

**JDK1.7 çš„ ConcurrentHashMap**ï¼š

![img_5.png](images%2Fimg_5.png)
`ConcurrentHashMap` æ˜¯ç”± `Segment` æ•°ç»„ç»“æ„å’Œ `HashEntry` æ•°ç»„ç»“æ„ç»„æˆã€‚

`Segment` æ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ åŒ…å«ä¸€ä¸ª `HashEntry` æ•°ç»„ï¼Œæ¯ä¸ª `HashEntry` æ•°ç»„å±äºé“¾è¡¨ç»“æ„ã€‚

**JDK1.8 çš„ ConcurrentHashMap**ï¼š

![img.png](images/img6.png)

JDK1.8 çš„ `ConcurrentHashMap` ä¸å†æ˜¯ **Segment æ•°ç»„ + HashEntry æ•°ç»„ + é“¾è¡¨**ï¼Œè€Œæ˜¯ **Node æ•°ç»„ + é“¾è¡¨ / çº¢é»‘æ ‘**ã€‚ä¸è¿‡ï¼ŒNode åªèƒ½ç”¨äºé“¾è¡¨çš„æƒ…å†µï¼Œçº¢é»‘æ ‘çš„æƒ…å†µéœ€è¦ä½¿ç”¨ **`TreeNode`**ã€‚å½“å†²çªé“¾è¡¨è¾¾åˆ°ä¸€å®šé•¿åº¦æ—¶ï¼Œé“¾è¡¨ä¼šè½¬æ¢æˆçº¢é»‘æ ‘ã€‚

`TreeNode`æ˜¯å­˜å‚¨çº¢é»‘æ ‘èŠ‚ç‚¹ï¼Œè¢«`TreeBin`åŒ…è£…ã€‚`TreeBin`é€šè¿‡`root`å±æ€§ç»´æŠ¤çº¢é»‘æ ‘çš„æ ¹ç»“ç‚¹ï¼Œå› ä¸ºçº¢é»‘æ ‘åœ¨æ—‹è½¬çš„æ—¶å€™ï¼Œæ ¹ç»“ç‚¹å¯èƒ½ä¼šè¢«å®ƒåŸæ¥çš„å­èŠ‚ç‚¹æ›¿æ¢æ‰ï¼Œåœ¨è¿™ä¸ªæ—¶é—´ç‚¹ï¼Œå¦‚æœæœ‰å…¶ä»–çº¿ç¨‹è¦å†™è¿™æ£µçº¢é»‘æ ‘å°±ä¼šå‘ç”Ÿçº¿ç¨‹ä¸å®‰å…¨é—®é¢˜ï¼Œæ‰€ä»¥åœ¨ `ConcurrentHashMap` ä¸­`TreeBin`é€šè¿‡`waiter`å±æ€§ç»´æŠ¤å½“å‰ä½¿ç”¨è¿™æ£µçº¢é»‘æ ‘çš„çº¿ç¨‹ï¼Œæ¥é˜²æ­¢å…¶ä»–çº¿ç¨‹çš„è¿›å…¥ã€‚

```java
static final class TreeBin<K,V> extends Node<K,V> {
        TreeNode<K,V> root;
        volatile TreeNode<K,V> first;
        volatile Thread waiter;
        volatile int lockState;
        // values for lockState
        static final int WRITER = 1; // set while holding write lock
        static final int WAITER = 2; // set when waiting for write lock
        static final int READER = 4; // increment value for setting read lock
...
}
```

### ConcurrentHashMap çº¿ç¨‹å®‰å…¨çš„å…·ä½“å®ç°æ–¹å¼/åº•å±‚å…·ä½“å®ç°

#### JDK1.8 ä¹‹å‰

![img_4.png](images%2Fimg_4.png)

é¦–å…ˆå°†æ•°æ®åˆ†ä¸ºä¸€æ®µä¸€æ®µï¼ˆè¿™ä¸ªâ€œæ®µâ€å°±æ˜¯ `Segment`ï¼‰çš„å­˜å‚¨ï¼Œç„¶åç»™æ¯ä¸€æ®µæ•°æ®é…ä¸€æŠŠé”ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹å ç”¨é”è®¿é—®å…¶ä¸­ä¸€ä¸ªæ®µæ•°æ®æ—¶ï¼Œå…¶ä»–æ®µçš„æ•°æ®ä¹Ÿèƒ½è¢«å…¶ä»–çº¿ç¨‹è®¿é—®ã€‚

**`ConcurrentHashMap` æ˜¯ç”± `Segment` æ•°ç»„ç»“æ„å’Œ `HashEntry` æ•°ç»„ç»“æ„ç»„æˆ**ã€‚

`Segment` ç»§æ‰¿äº† `ReentrantLock`,æ‰€ä»¥ `Segment` æ˜¯ä¸€ç§å¯é‡å…¥é”ï¼Œæ‰®æ¼”é”çš„è§’è‰²ã€‚`HashEntry` ç”¨äºå­˜å‚¨é”®å€¼å¯¹æ•°æ®ã€‚

```java
static class Segment<K,V> extends ReentrantLock implements Serializable {
}
```

ä¸€ä¸ª `ConcurrentHashMap` é‡ŒåŒ…å«ä¸€ä¸ª `Segment` æ•°ç»„ï¼Œ`Segment` çš„ä¸ªæ•°ä¸€æ—¦**åˆå§‹åŒ–å°±ä¸èƒ½æ”¹å˜**ã€‚ `Segment` æ•°ç»„çš„å¤§å°é»˜è®¤æ˜¯ 16ï¼Œä¹Ÿå°±æ˜¯è¯´é»˜è®¤å¯ä»¥åŒæ—¶æ”¯æŒ 16 ä¸ªçº¿ç¨‹å¹¶å‘å†™ã€‚

`Segment` çš„ç»“æ„å’Œ `HashMap` ç±»ä¼¼ï¼Œæ˜¯ä¸€ç§æ•°ç»„å’Œé“¾è¡¨ç»“æ„ï¼Œä¸€ä¸ª `Segment` åŒ…å«ä¸€ä¸ª `HashEntry` æ•°ç»„ï¼Œæ¯ä¸ª `HashEntry` æ˜¯ä¸€ä¸ªé“¾è¡¨ç»“æ„çš„å…ƒç´ ï¼Œæ¯ä¸ª `Segment` å®ˆæŠ¤ç€ä¸€ä¸ª `HashEntry` æ•°ç»„é‡Œçš„å…ƒç´ ï¼Œå½“å¯¹ `HashEntry` æ•°ç»„çš„æ•°æ®è¿›è¡Œä¿®æ”¹æ—¶ï¼Œå¿…é¡»é¦–å…ˆè·å¾—å¯¹åº”çš„ `Segment` çš„é”ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¯¹åŒä¸€ `Segment` çš„å¹¶å‘å†™å…¥ä¼šè¢«é˜»å¡ï¼Œä¸åŒ `Segment` çš„å†™å…¥æ˜¯å¯ä»¥å¹¶å‘æ‰§è¡Œçš„ã€‚

#### JDK1.8 ä¹‹å

![img_3.png](images%2Fimg_3.png)

Java 8 å‡ ä¹å®Œå…¨é‡å†™äº† `ConcurrentHashMap`ï¼Œä»£ç é‡ä»åŸæ¥ Java 7 ä¸­çš„ 1000 å¤šè¡Œï¼Œå˜æˆäº†ç°åœ¨çš„ 6000 å¤šè¡Œã€‚

`ConcurrentHashMap` å–æ¶ˆäº† `Segment` åˆ†æ®µé”ï¼Œé‡‡ç”¨ `Node + CAS + synchronized` æ¥ä¿è¯å¹¶å‘å®‰å…¨ã€‚æ•°æ®ç»“æ„è·Ÿ `HashMap` 1.8 çš„ç»“æ„ç±»ä¼¼ï¼Œæ•°ç»„+é“¾è¡¨/çº¢é»‘äºŒå‰æ ‘ã€‚Java 8 åœ¨é“¾è¡¨é•¿åº¦è¶…è¿‡ä¸€å®šé˜ˆå€¼ï¼ˆ8ï¼‰æ—¶å°†é“¾è¡¨ï¼ˆå¯»å€æ—¶é—´å¤æ‚åº¦ä¸º O(N)ï¼‰è½¬æ¢ä¸ºçº¢é»‘æ ‘ï¼ˆå¯»å€æ—¶é—´å¤æ‚åº¦ä¸º O(log(N))ï¼‰ã€‚

Java 8 ä¸­ï¼Œé”ç²’åº¦æ›´ç»†ï¼Œ`synchronized` åªé”å®šå½“å‰é“¾è¡¨æˆ–çº¢é»‘äºŒå‰æ ‘çš„é¦–èŠ‚ç‚¹ï¼Œè¿™æ ·åªè¦ hash ä¸å†²çªï¼Œå°±ä¸ä¼šäº§ç”Ÿå¹¶å‘ï¼Œå°±ä¸ä¼šå½±å“å…¶ä»– Node çš„è¯»å†™ï¼Œæ•ˆç‡å¤§å¹…æå‡ã€‚

### JDK 1.7 å’Œ JDK 1.8 çš„ ConcurrentHashMap å®ç°æœ‰ä»€ä¹ˆä¸åŒï¼Ÿ

- **çº¿ç¨‹å®‰å…¨å®ç°æ–¹å¼**ï¼šJDK 1.7 é‡‡ç”¨ `Segment` åˆ†æ®µé”æ¥ä¿è¯å®‰å…¨ï¼Œ `Segment` æ˜¯ç»§æ‰¿è‡ª `ReentrantLock`ã€‚JDK1.8 æ”¾å¼ƒäº† `Segment` åˆ†æ®µé”çš„è®¾è®¡ï¼Œé‡‡ç”¨ `Node + CAS + synchronized` ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œé”ç²’åº¦æ›´ç»†ï¼Œ`synchronized` åªé”å®šå½“å‰é“¾è¡¨æˆ–çº¢é»‘äºŒå‰æ ‘çš„é¦–èŠ‚ç‚¹ã€‚
- **Hash ç¢°æ’è§£å†³æ–¹æ³•** : JDK 1.7 é‡‡ç”¨æ‹‰é“¾æ³•ï¼ŒJDK1.8 é‡‡ç”¨æ‹‰é“¾æ³•ç»“åˆçº¢é»‘æ ‘ï¼ˆé“¾è¡¨é•¿åº¦è¶…è¿‡ä¸€å®šé˜ˆå€¼æ—¶ï¼Œå°†é“¾è¡¨è½¬æ¢ä¸ºçº¢é»‘æ ‘ï¼‰ã€‚
- **å¹¶å‘åº¦**ï¼šJDK 1.7 æœ€å¤§å¹¶å‘åº¦æ˜¯ Segment çš„ä¸ªæ•°ï¼Œé»˜è®¤æ˜¯ 16ã€‚JDK 1.8 æœ€å¤§å¹¶å‘åº¦æ˜¯ Node æ•°ç»„çš„å¤§å°ï¼Œå¹¶å‘åº¦æ›´å¤§ã€‚

## Collections å·¥å…·ç±»ï¼ˆä¸é‡è¦ï¼‰

**`Collections` å·¥å…·ç±»å¸¸ç”¨æ–¹æ³•**:

- æ’åº
- æŸ¥æ‰¾,æ›¿æ¢æ“ä½œ
- åŒæ­¥æ§åˆ¶(ä¸æ¨èï¼Œéœ€è¦çº¿ç¨‹å®‰å…¨çš„é›†åˆç±»å‹æ—¶è¯·è€ƒè™‘ä½¿ç”¨ JUC åŒ…ä¸‹çš„å¹¶å‘é›†åˆ)

### æ’åºæ“ä½œ

```java
void reverse(List list)//åè½¬
void shuffle(List list)//éšæœºæ’åº
void sort(List list)//æŒ‰è‡ªç„¶æ’åºçš„å‡åºæ’åº
void sort(List list, Comparator c)//å®šåˆ¶æ’åºï¼Œç”±Comparatoræ§åˆ¶æ’åºé€»è¾‘
void swap(List list, int i , int j)//äº¤æ¢ä¸¤ä¸ªç´¢å¼•ä½ç½®çš„å…ƒç´ 
void rotate(List list, int distance)//æ—‹è½¬ã€‚å½“distanceä¸ºæ­£æ•°æ—¶ï¼Œå°†listådistanceä¸ªå…ƒç´ æ•´ä½“ç§»åˆ°å‰é¢ã€‚å½“distanceä¸ºè´Ÿæ•°æ—¶ï¼Œå°† listçš„å‰distanceä¸ªå…ƒç´ æ•´ä½“ç§»åˆ°åé¢
```

### æŸ¥æ‰¾,æ›¿æ¢æ“ä½œ

```java
int binarySearch(List list, Object key)//å¯¹Listè¿›è¡ŒäºŒåˆ†æŸ¥æ‰¾ï¼Œè¿”å›ç´¢å¼•ï¼Œæ³¨æ„Listå¿…é¡»æ˜¯æœ‰åºçš„
int max(Collection coll)//æ ¹æ®å…ƒç´ çš„è‡ªç„¶é¡ºåºï¼Œè¿”å›æœ€å¤§çš„å…ƒç´ ã€‚ ç±»æ¯”int min(Collection coll)
int max(Collection coll, Comparator c)//æ ¹æ®å®šåˆ¶æ’åºï¼Œè¿”å›æœ€å¤§å…ƒç´ ï¼Œæ’åºè§„åˆ™ç”±Comparatatorç±»æ§åˆ¶ã€‚ç±»æ¯”int min(Collection coll, Comparator c)
void fill(List list, Object obj)//ç”¨æŒ‡å®šçš„å…ƒç´ ä»£æ›¿æŒ‡å®šlistä¸­çš„æ‰€æœ‰å…ƒç´ 
int frequency(Collection c, Object o)//ç»Ÿè®¡å…ƒç´ å‡ºç°æ¬¡æ•°
int indexOfSubList(List list, List target)//ç»Ÿè®¡targetåœ¨listä¸­ç¬¬ä¸€æ¬¡å‡ºç°çš„ç´¢å¼•ï¼Œæ‰¾ä¸åˆ°åˆ™è¿”å›-1ï¼Œç±»æ¯”int lastIndexOfSubList(List source, list target)
boolean replaceAll(List list, Object oldVal, Object newVal)//ç”¨æ–°å…ƒç´ æ›¿æ¢æ—§å…ƒç´ 
```

### åŒæ­¥æ§åˆ¶

`Collections` æä¾›äº†å¤šä¸ª`synchronizedXxx()`æ–¹æ³•Â·ï¼Œè¯¥æ–¹æ³•å¯ä»¥å°†æŒ‡å®šé›†åˆåŒ…è£…æˆçº¿ç¨‹åŒæ­¥çš„é›†åˆï¼Œä»è€Œè§£å†³å¤šçº¿ç¨‹å¹¶å‘è®¿é—®é›†åˆæ—¶çš„çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚

æˆ‘ä»¬çŸ¥é“ `HashSet`ï¼Œ`TreeSet`ï¼Œ`ArrayList`,`LinkedList`,`HashMap`,`TreeMap` éƒ½æ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ã€‚`Collections` æä¾›äº†å¤šä¸ªé™æ€æ–¹æ³•å¯ä»¥æŠŠä»–ä»¬åŒ…è£…æˆçº¿ç¨‹åŒæ­¥çš„é›†åˆã€‚

**æœ€å¥½ä¸è¦ç”¨ä¸‹é¢è¿™äº›æ–¹æ³•ï¼Œæ•ˆç‡éå¸¸ä½ï¼Œéœ€è¦çº¿ç¨‹å®‰å…¨çš„é›†åˆç±»å‹æ—¶è¯·è€ƒè™‘ä½¿ç”¨ JUC åŒ…ä¸‹çš„å¹¶å‘é›†åˆã€‚**

æ–¹æ³•å¦‚ä¸‹ï¼š

```java
synchronizedCollection(Collection<T>  c) //è¿”å›æŒ‡å®š collection æ”¯æŒçš„åŒæ­¥ï¼ˆçº¿ç¨‹å®‰å…¨çš„ï¼‰collectionã€‚
synchronizedList(List<T> list)//è¿”å›æŒ‡å®šåˆ—è¡¨æ”¯æŒçš„åŒæ­¥ï¼ˆçº¿ç¨‹å®‰å…¨çš„ï¼‰Listã€‚
synchronizedMap(Map<K,V> m) //è¿”å›ç”±æŒ‡å®šæ˜ å°„æ”¯æŒçš„åŒæ­¥ï¼ˆçº¿ç¨‹å®‰å…¨çš„ï¼‰Mapã€‚
synchronizedSet(Set<T> s) //è¿”å›æŒ‡å®š set æ”¯æŒçš„åŒæ­¥ï¼ˆçº¿ç¨‹å®‰å…¨çš„ï¼‰setã€‚
```
